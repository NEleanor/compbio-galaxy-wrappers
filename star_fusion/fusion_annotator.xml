<tool id="fusion_annotator" name="Fusion Annotator" version="@VERSION@.0" profile="17.09">
    <description>Annotate STAR gene fusion predictions</description> 

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements"/>

    <version_command>FusionAnnotator --version</version_command>
    
    <command><![CDATA[       
        ## 1. Create genome reference library
        #if $genome_lib_type.genome_lib_type_selector == "build_lib":
        prep_genome_lib.pl
            --genome_fa '${genome_lib_type.fasta_type.ownFile.fields.path}'
            --gtf '${geneModel}'
            --fusion_annot_lib ${fusion_annot_lib}
            --annot_filter_rule ${annot_filter_rule}
            --pfam_db ${pfam_db}
            #if $gmap_build:
            --gmap_build ${gmap_build}
            #end if
            --CPU \${GALAXY_SLOTS:-1}
            #if $genome_lib_type.max_readlength:
            --max_readlength ${genome_lib_type.max_readlength}
            #end if
            &&
        #end if

        ## 2. Run FusionAnnotator
        FusionAnnotator
        --annotate $fusions

	    #if $genome_lib_type.genome_lib_type_selector == "build_lib":
	    --genome_lib_dir "\$(pwd)/ctat_genome_lib_build_dir"
	    #else if $genome_lib_type.genome_lib_type_selector == "prebuilt":
	    --genome_lib_dir ${genome_lib_type.prebuilt_lib.fields.path}
        #end if

        #if $full:
            --full
        #end if
        > $output_annotations
    ]]></command>

    <inputs>
        <param name="fusions" type="data" format="tabular,tsv" label="Fusion Predictions"/>    
        <!-- Genome source. -->
	    <conditional name="genome_lib_type">
            <param name="genome_lib_type_selector" type="select" label="Genome library source">
	            <option value="prebuilt">Pre-built library</option>
		        <option value="build_lib">Build Library</option>
            </param>
	        <when value="build_lib">
	            <conditional name="fasta_type">
                    <param name="fasta_type_selector" type="select" label="Source for sequence to search">
                        <option value="cached">Locally Cached sequences</option>
                        <option value="history" selected="true">Sequences from your history</option>
                    </param>
                    <when value="cached">
                        <param name="ownFile" type="select" label="Genome to search">
                            <options from_data_table="all_fasta">
                                <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file."/>
                            </options>
                        </param>
                    </when>
                    <when value="history">
                        <param name="ownFile" type="data" format="fasta" label="Select the reference genome (FASTA file)"/>
                    </when>
                </conditional>
       
                <param name="geneModel" type="data" format="gff3,gtf" label="Gene model (gff3,gtf) file for splice junctions and fusion gene detection"/>
                <param name="fusion_annot_lib" type="data" format="txt,tsv,tabular" label="Fusion Annotation Library"/>
                <param name="annot_filter_rule" type="data" format="txt" optional="true" label="Target AnnotFilerRule.pm"/>
                <param name="pfam_db" type="data" format="txt,tsv,tabular" optional="true" label="PFAM Database"/>
                <param name="gmap_build" type="data" format="txt,tsv,tabular" optional="true" label="GMAP Build"/>
                <param name="max_readlength" type="integer" optional="true" label="Maximum Read Length"/>
 	        </when>
            <when value="prebuilt">
                <param name="prebuilt_lib" type="select" label="Genome library to search">
		            <options from_data_table="star_fusion_genome_lib">
                        <validator type="no_options" message="A pre-built STAR-fusion genome library is not available for the build associated with the selected input file"/>
		            </options>
		        </param>
	        </when> 
        </conditional>
        <param name="full" type="boolean" checked="false" label="Include Full Annotation"/> 
    </inputs>

    <outputs>
        <data format="tabular" name="output_annotations" label="${tool.name} on ${on_string}: ANNOTATED FUSIONS"/> 
    </outputs>

    <help>
**What it does**

STAR-Fusion is a component of the Trinity Cancer Transcriptome Analysis Toolkit (CTAT). STAR-Fusion uses the STAR aligner to identify candidate fusion transcripts supported by Illumina reads. STAR-Fusion further processes the output generated by the STAR aligner to map junction reads and spanning reads to a reference annotation set. This tool takes a long time to run because it is building the STAR index on the fly. We can fix this later. 

**Input: files required to run STAR-Fusion**
 - A genome reference sequence (FASTA-format)
 - A corresponding protein-coding gene annotation set (GTF/GFF Format)
 - A last-matching gene pairs file - in Galaxy you can create such files with the *ncbi_blast_plus* tool suite containing *blastn*: https://toolshed.g2.bx.psu.edu/view/devteam/ncbi_blast_plus
 - A STAR chimeric/junction output file - this is optional as STAR Fusion can control running STAR as well.

The authors of STAR Fusion have made some of these files avaialble at: https://data.broadinstitute.org/Trinity/CTAT_RESOURCE_LIB/. The gene annotations in each case are restricted to the protein-coding and lincRNA transcripts.
More info: https://github.com/STAR-Fusion/STAR-Fusion/wiki

    </help>

    <citations>
        <citation type="bibtex">
           @unpublished{star_fusion,
              author = {Brian Haas and Nicolas Stransky and Daniel Nicorici}, 
              title  = {STAR-Fusion},
              url    = {https://github.com/STAR-Fusion/STAR-Fusion}
            }
        </citation>
    </citations>
</tool>
